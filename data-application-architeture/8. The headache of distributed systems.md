# 분산 시스템의 골칫거리
**어떤 것이든 잘못될 가능성이 있다면 잘못된다**  
분산 시스템을 다루는 것은 한 컴퓨터에서 실행되는 소프트웨어를 작성하는 일과 근본적으로 다르다.  
핵심적인 차이는 뭔가 잘못될 수 있는 흥미진진한 방법이 많다는 점  

## 결함과 부분 장애
한 컴퓨터에서 프로그램을 작성하는 경우 보통 예측 가능한 방식으로 동작 돌아가거나 돌아가지 않음  
단일 컴퓨터에서 실행되는 소프트웨어를 믿지 못할 근복적인 이유는 없으며, 하드웨어가 정상적으로 동작하는 경우 같은 연산은 항상 같은 결과를 낸다. 하드웨어에 문제가 있는 경우 보통 시스템이 완전히 실패  
분산 시스템에서는 이상화된 시스템 모델에서 동작하지 않는대 하나의 시스템에서 장애가 발생하더라도 다른 시스템에서 잘 동작하는 등 예측할 수 없는 방식으로 장애가 발생할 수 있는데, 이를 **부분 장애(partial failure)** 라고 함. 부분 장애는 비결정적으로 여러 노드와 네트워크와 관련된 뭔가를 시도하면 어떨 때는 동작하지만 어떨 때는 예측할 수 없는 방식으로 실패하며, 심지어 뭔가 성공했는지 아닌지 알지 못할 수도 있다.  

### 클라우드 컴퓨팅과 슈퍼컴퓨팅
대규모 컴퓨팅 시스템 구축 방법
- 고성능 컴퓨팅(High-performance Computing, HPC) 수천 개의 CPU를 가진 슈퍼컴퓨터는 보통 일기예보나 분자 동력학 처럼 계산 비용이 매우 높은 과학 계산 작업에 사용
- 클라우드 컴퓨팅 멀티 테넌트 데이터센터, IP 네트워크로 연결된 상용 컴퓨터, 신축적/주문식 자원 할당, 계량 결제와 관련에 사용

#### 슈퍼 컴퓨터
- 계산 상태를 지속성 있는 저장소에 체크포인트로 저장
- 노드 하나에 장애가 발생했을 때 전체 클러스터 작업부하를 중단
- 장애 복구후 마지막 체크포인트부터 계산 재시작
- 분산 시스템보다 단일 노드 컴퓨터와 가까움
- 부분의 장애를 전체를 장애로 확대하여 처리
- 일괄 처리 등 작업을 멈췄다 시작해도 충격이 덜 한 시스템에 사용

#### 클라우드 컴퓨팅
- 낮은 지연시간을 가지는 서비스를 제공하는 온라인
- 다중 노드 환경
- 부분 장애의 가능성을 생각하고 소프트웨어에 내결함성 메커니즘이 필요

분산 시스템 환경에서는 부분 장애를 고려하는 것이 매우 중요  
몇 개의 노드만으로 구성된 작은 시스템의 경우 시스템에서는 거의 항상 구성 요소 대부분이 올바르게 동작할 가능성이 있지만 언젠가는 결함이 발생하고 결함을 처리해야함  
발생 가능성이 상당히 낮더라도 생길 수 있는 결함을 광범위하게 고려하고 테스트하는 것이 중요

#### 신뢰성 없는 구성 요소를 사용해 신뢰성 있는 시스템 구축하기
구성 요소에서 발생할 수 있는 문제에 대해 인지하고 신뢰성을 높일 수 있는 방법을 적용

## 신뢰성 없는 네트워크
분산 시스템은 **비공유 시스템** , 즉 네트워크로 연결된 다수의 장비이며 자신만의 장비와 메모리를 가짐.  
서로 간의 메모리나 디스크에 접근할 수 없다고 가정  
인터넷과 데이터센터 내부 네트워크는 대부분 **비동기 패킷 네트워크(asynchronous packet network)** 로 다른 노드로 메세지를 보낼 수 있지만 메세지가 언제 도착할지 메세지가 도착하기는 할 것인지 보장하지 않음  
요청을 보낸 후 여러 가지 이유로 잘못될 수 있음
1. 요청 손실(케이블 뽑힘)
2. 요청이 큐에서 대기하다가 나중에 전송(네트워크나 수신자에 과부하 가능성)
3. 원격 노드에 장애가 생겼을 가능성(죽었거나 전원 관련 이슈)
4. 원격 노드가 일시적으로 응답을 멈춘 후 다시 응답
5. 원격 노드가 응답을 처리했지만 응답이 네트워크에서 손실(네트워크 스위치 설정 문제)
6. 원격 노드가 요청을 처리했지만 지연되다가 나중에 전송
![8.1](images/8.1.png)  

이런 문제를 흔히 해결하는 방법은 **타임아웃** 얼마 간의 시간이 지나면 응답 대기를 멈추고 응답이 도착하지 않는다고 가정  

### 현실의 네트워크 결함
실제 중간 규모의 IDC센터에서의 사례
1. 단일 장비의 연결이 끊어짐
2. 전체 랙의 연결이 끊어짐
3. 상어가 해저 케이블을 물어뜯어 손상
   
등 다양한 이유로 네트워크 결함이 발생할 수 있고 이렇게 발생하는 문제를 **네트워크 결함(network fault)** 라고 정의

네트워크 결함에 대한 정의 테스트가 이루어지지 않는다면 아래와 같은 일이 발생할 수 있다.
- 네트워크가 복구되어도 요청을 처리할 수 없음
- 모든 데이터를 삭제  

하지만 네트워크가 상당한 신뢰성을 보장한다면 네트워크 결함을 반드시 처리하도록 보장해야하는 것은 아니며 네트워크에 문제가 있을 시 사용자에게 오류 메세지를 보여주는 것도 하나의 방법  

### 결함 감지
- 로드 밸런서는 죽은 노드로 요청을 그만 보내야 한다.
- 단일 리더 복제를 사용하는 분산 데이터베이스에서 리더에 장애가 나면 팔로워 중 하나가 리더로 승격되어야 한다.

하지만 네트워크는 불확실성으로 인해 노드가 동작 중인지 아닌지 구별하기 어려우며, 어떤 특정한 환경에서는 뭔가 동작하지 않는다고 명시적으로 알려주는 피드백을 받는 것도 가능
- 노드가 실행 중인 장비에 연결할 수 있지만 목적지 포트에서 수신 대기하는 프로세스가 없다면 운영체제가 친절하게 RST나 FIN 패킷을 응답으로 보내서 TCP연결을 거부
- 노드 프로세스가 죽었지만 노드의 운영체제는 아직 실행중이라면 스크립트로 다른 노드에게 프로세스가 죽었다고 알려서 다른 노드의 타임아웃이 만료되기를 기다릴 필요 없음
- 데이터센터 내 네트워크 스위치의 관리 인터페이스에 접근할 수 있으면 질의를 보내 하드웨어 수준의 링크 장애를 감지
- 접속하려는 IP 주소에 도달할 수 없다고 라우터가 확신하면 ICMP Destination Unreachable패킷으로 응답

원격 노드가 다운되고 있다는 빠른 피드백은 유용하지만 전달받은 것에 대한 확인 응답과 처리 응답은 다르므로 의존할 수 없으며 아무 응답도 받지 못하는 경우도 가정해야함

### 타임아웃과 기약 없는 지연
타임아웃이 길면 노드가 죽었다고 선언될 때까지 기다리는 시간이 길어지며, 짧으면 결함을 빨리 발견하지만 노드가 일시적으로 느려졌을 뿐인데도 죽었다고 잘못 선언할 위험이 높아짐  
너무 빨리 노드가 죽었다고 판단하는 경우 해당 노드에서 처리해야할 요청이 다른 노드로 전달되어 부하가 발생할 수 있으며 이는 연쇄 장애를 유발할 수 있다.  
모든 패킷이 d내에 전송되거나 손실되지만 전송 시간이 결코 d보다 더 걸리지 않고 장애가 나지 않은 노드는 항상 요청을 r 시간 내에 처리한다고 보장할 수 있다면 성공한 모든 요청은 2d + r 시간 내에 응답을 받는다고 보장  
비동기 네트워크는 **기약 없는 지연(unbounded deley)** 가 존재

### 네트워크 혼잡과 큐 대기
- 여러 노드에서 동시에 같은 목적지로 패킷을 보내려고 하면 네트워크 스위치는 패킷을 큐에 넣고 한 번에 하나씩 목적지 네트워크로 전달하는데 네트워크 링크가 붐비면 패킷은 슬롯을 얻을 수 있을때까지 대기 **네트워크 혼잡** 이라 한다.
- 패킷이 목적지에 도착해도 모든 CPU코어가 바쁜 상태라면 네트워크에 들어온 요청은 애플리케이션에서 처리할 준비가 될 때까지 운영체제가 큐에 넣어둔다.
- 가상 환경에서 실행되는 운영체제는 다른 가상 장비가 CPU 코어를 사용하는 동안 수십 밀리초 동안 멈출때가 흔하다.
- TCP는 흐름 제어를 수행하여 노드가 네트워크 링크나 수신 노드에 과부하를 가하지 않도록 자신의 송신율을 제한하는데, 이는 데이터가 네트워크로 들어가기 전에도 부가적인 큐를 대기할 수 있다는 뜻
![8.2](images/8.2.png)  

네트워크 환경에서의 타임아웃은 지연의 변동성이 얼마나 되는지 알 수 없기 때문에 충분한 테스트를 통해서 네트워크 왕복 시간의 분포를 측정해야하며, 트레이드 오프 사이에서 적절한 값을 결정해야 함

#### TCP와 UDP
TCP : 타임아웃 안에 확인 응답을 받지 않으면 패킷이 손실되었다고 간주하고 재전송  
UCP : 흐름 제어를 하지 않고 손실된 패킷을 재전송하지 않음

### 동기 네트워크 대 비동기 네트워크
패킷 전송 지연시간의 최대치가 고정된다면 패킷을 유실하지 않는 네트워크에 기댈 수 있다면 분산 시스템은 훨씬 더 단순해진다.
전화 네트워크는 극단적인 신뢰성을 지니며 회선을 만들어 두 명 사이에 있는 전체 경로를 따라 보장된 대역폭을 할당받아 사용하고 이를 **동기식 네트워크** 라고 한다.  
동기식 네트워크는 큐 대기가 없으므로 네트워크 종단 지연 시간의 최대치가 고정되며 **제한 있는 지연(bounded delay)** 라고 한다.  

### 네트워크 지연 예측
회선이 만들어져 있는 경우 다른 누구도 사용할 수 없는 고정된 대역폭을 할당받지만 TCP는 가변적으로 사용하기 때문에 네트워크 지연 예측은 불가능  
TCP는 순간적으로 몰리는 트래픽에 대해 최적화되어 있고 여러 용도(웹 페이지 요청, 이메일 전송, 파일 전송)로 사용되기 때문에 예측이 쉽지 않고 대역폭을 미리 할당하는 것이 어렵다.  
예측을 위해 **서비스 품질(Quality of Service, QoS)와 진입 제어(admission control)** 을 사용할 수 있다.

## 신뢰성 없는 시계
1. 이 요청이 타임아웃됐나?
2. 이 서비스의 99분위 응답 시간은 어떻게 되나?
3. 이 서비스는 지난 5분 동안 평균 초당 몇 개의 질의를 처리했나?
4. 사용자가 우리 사이트에서 시간을 얼마나 보냈나?
5. 이 기사가 언제 게시됐나?
6. 며칠 몇시에 미리 알림 이메일을 보내야 하나?
7. 이 캐시 항목은 언제 만료되나?
8. 로그 파일에 남은 이 오류 메세지의 타임스탬프는 무엇인가?

