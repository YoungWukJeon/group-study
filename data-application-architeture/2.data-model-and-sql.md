# 2장 데이터 모넬과 질의 언어 

- 데이터 모델은 소프트웨어 개발에서 제일 중요한 부분
- 데이터 모델은 **문제를 어떻게 해결해야 하는지에** 대해서도 큰 영향을 미침 
  
대부분의 어플리케이션 여러 데이터 모델을 계층을 둬서 만든다 
- 개발자는 현실의 구조를 다루는 API 를 모델링한다 
- 데이터 구조 저장하는 방법은 JSON, XML, 관계형 데이터 베이스의 테이블, 그래프 모델 등이 있다 
  
## 관계형 모델과 문서 모델 

오늘날 가장 잘 알려진 데이터 모델은 1970년도에 에드가 코드(Edgar Codd)가 제안한 관계형 모델을 기반으로 한 SQL이다.  
데이터는 **관계**로 구성되고 각 관계는 순서 없는 **튜플** 모음이다.  
관계형 데이터 베이스에 근원은 1960 ~ 1970 년대에 **비즈니스 데이터 처리** 에 있다. 이 사례는 보통 **트랜잭션 처리**와 **일괄 처리**로 오늘날 일상적으로 수행되는 일이다.  

1970 ~ 1980 년대 초반에는 **네트워크 모델**과 **계층 모델**이 관계형 모델에 대한 대안이었지만 결국 관계형 모델이 우위를 차지했다.  


### NoSQL 탄생 
2010년대에 NoSQL 은 관계형 모델의 우위를 뒤집으려는 최신의 시도다.  
NoSQL 은 Not Only SQL 을 의미한다.  
  
NoSQL 데이터베이스를 채택한 이유 
- 대규모 데이터셋이나 **매우 높은 쓰기 처리량** 달성을 관계형 데이터베이스보다 쉽게 할 수 있다  
- 상용 데이터베이스 제품보다 무료 오픈소스 소프트웨어에 대한 선호도 확산 > NoSQL 은 오픈소스가 많음 
- 관계형 모델에서 지원하지 않는 특수 질의 동작 
- **관계형 스키마의 제한에 대한 불만**과 동적이고 표현력이 풍부한 데이터 모델에 대한 바람 

가까운 미래에는 관계형과 비관계형을 함께 사용할 것이다. 이를 **다중 저장소 지속성(polyglot persistence)**  이라 한다  

### 객체 관계형 불일치 
대부분의 어플리케이션은 객체지향 프로그래밍 언어로 개발한다. 데이터를 관계형 테이블에 저장하려면 어플리케이션 코드와 데이터 베이스 모델 객체(테이블에 매핑되는 객체) 사이에 전환 계층이 필요하다. 이런 모델 사이의 분리를 **임피던스 불일치(impedencae mismatch)** 라고 한다.  
  
Active Record 나 Hibernate 같은 ORM 프레임워크는 전환 계층에 필요한 코드의 양을 줄이지만 두 모델간의 차이를 완벽히 숨길 순 없다. 
  
이력서에 대한 관계형 스키마 예시를 보자  
![2_profile_relation_db](images/2_profile_relation_db.jpeg)
- 이력서는 user_id 로 식별한다 
- 이름과 달리 직업, 경력은 하나 이상이며 다양할 수 있다.
- 따라서 사용자와 이런 항목들(직업, 경력)은 일대다 관계이다.

이력서 같은 데이터 구조는 모든 내용을 갖추고 있는 **문서** 라서 JSON 표현이 매우 적합하다.  
- 몽고DB, RethinkDB, CouchDB 같은 문서지향 데이터베이스는 JSON 형식을 지원함  
```json
{
    "user_id": 251,
    "first_name": "Bill",
    "last_name": "Gates",
    // 중략 .. 
    "positions": [
        {"job_title": "Co-chair", "organization": "Bill & Medlinda Gates Foundation"},
        {"job_title": "Co-founder, Chairman", "organization": "Microsoft"}
    ],
    // 중략 ..
}
```
- 일부 개발자들은 JSON 모델이 어플리케이션 코드와 저장 계층 간 임피던스 불일치를 줄인다고 생각한다.
- 데이터 부호화 형식으로써 JSON 이 가진 문제점도 있다. (4장에서 설명한다)
- JSON 표현은 다중 테이블 스키마보다 더 나은 지역성(locality)을 갖는다 
    * 관계형 예제에서 이력서를 가져오려면 다중 질의나 조인을 수행해야 한다 
    * JSON 표현에서는 모든 관련 정보가 한 곳에서 있어서 질의 하나로 충분하다 

### 다대일과 대다다 관계 
앞에 관계형 모델의 그림에서 region_id 는 평문인 "그레이터 시애틀 구역" 이 아닌 ID 로 주어졌다.  
ID 와 텍스트 문자열의 저장 여부는 **중복**의 문제이다. ID 를 사용하는 경우 사람에게 의미있는 문자열은 한 곳에 저장하고 (row) 그것을 참조하는 모든것은 ID 를 사용한다. (ID 는 데이터 내에서만 의미가 있음)  
ID 를 사용하는 장점으로는 ID 는 아무런 의미를 갖지 않기 때문에 변경할 필요가 없다.  
하지만 ID 가 의미를 갖게 된다면 언젠가는 ID 를 변경해야 할 수도 있다. 만약 정보가 중복된다면 **모든 중복 항목을 변경해야 한다.** 이것은 쓰기 오버 헤드와 불일치의 위험이 있다.  
  
중복된 데이터를 정규화 하려면 **다대일** 관계가 필요한데 안타깝게도 **다대일관계는 문서모델에 적합하지 않다**.  
관계형 데이터베이스는 조인이 쉽기 때문에 ID 로 다른 테이블의 로우를 참조하는 게 일반적이다.  
문서 데이터베이스는 일대다 트리 구조로 보통 조인이 필요하지 않고 조인에 대한 지원도 약하다.  

데이터베이스가 조인을 지원하지 않으면 어플리케이션 코드에서 조인을 흉내내야 한다.  
어플리케이션 초기 버전이 조인이 없는 문서 모델에 적합하다고 하더라도 어플리케이션에 기능을 추가하면서 **데이터는 점차 상호 연결되는** 경향이 있다.  
  
이전 예제에서 추천서를 작성하는 기능을 추가한다고 해보자.  
- 추천받은 사용자 이력서에는 추천인의 이름과 사진이 함께 보여진다.
- 추천인이 자신의 사진을 갱신하면 모든 추천서에 새로운 사진을 반영해야한다.

![2_many_to_many](images/2_many_to_many.jpeg)
- 추천서와 같은 새로운 기능은 위 그림 처럼 **다대다 관계**를 필요로 한다.
- 각 점선 내 데이터는 하나의 문서로 묶을 수 있지만 조직, 학교, 기타 사용자는 참조로 표현해야 하고 질의 할 때는 조인이 필요하다. 

## 문서 데이터 베이스는 역사를 반복하고 있나 ? 
1970 년대 IBM의 정보관리시스템 IMS 는 아폴로 우주 프로그램에서 재고관리를 위해서 개발되었다. 
IMS 는 계층 모델을 사용했고 문서 데이터베이스의 JSON 모델과 비슷하다. 
IMS 는 일대다 관계에서는 잘 동작하지만 다대다 관계 표현은 어려웠다.  

계층의 모델의 한계를 해결하기 위해서 다양한 해결책이 제안됬다. 관계형 모델과 네트워크 모델이 대표적이다.  

### 네트워트 모델 
네트워크 모델은 코다실(CODASYL)이라고 불리는 위원회에서 표준화했다. 
계층 모델의 트리 구조에서 모든 레코드는 정확하게 하나의 부모가 있다.
네트워크 모델에서 레코드는 다중 부모가 있을 수 있다. 

네트워크 모델에서 레코드 간 연결은 외래 키보다는 프로그래밍 언어의 포인터와 더 비슷하다. 
레코드에 접근하는 유일한 방법은 최상위 레코드에서 부터 연결 정보를 따르는 방법이다. (접근경로) 
- 맨 앞 레코드에서 원하는 레코드가 나올때 까지 탐색하는 방법이다.  

이 모델의 문제점은 다중 부모를 갖게 될 경우 어플리케이션 코드는 다양한 관게를 모두 추적해야 한다. (탐색 느림)
그리고 데이터베이스 질의와 갱신을 위한 코드가 복잡하고 유연하지 못했다.  
접근 경로는 변경 할 수 있지만 아주 많은 수작업 데이터베이스 질의 코드를 살펴보고 접근경로 질의를 재작성 해야 했다.  

### 관계형 모델 
대조적으로 관계형 모델은 알려진 모든 데이터를 배치하는 것이다.  
관계(테이블)과 튜플(로우)가 전부다. 따라서 중첩 구조와 데이터를 보고 싶을 때 따라가야 할 복잡한 접근경로가 없다.
임의 조건과 일치하는 로우를 선택해서 읽을 수 있고 다른 테이블과의 관계에 신경 쓰지 않고 테이블에 새 로우를 삽입할 수 있다.  
관계형 데이터베이스에서는 질의 최적화기(Query Optimizer)는 어떤 순서로 질의를 실행할지 결정하고 사용할 색인을 자동을 결정한다.  
네트워크 모델과 가장 큰 차이점은 접근 경로를 개발자가 아닌 **질의 최적화기가 자동으로 만든다**는 점이다.  
  
관계형 모델의 가장 큰 장점으로 질의 최적화기를 한번 만들면 데이터베이스를 사용하는 모든 어플리케이션이 혜택을 받을 수 있다는 점이다.  

### 문서 데이터베이스와의 비교 
문서 데이터베이스는 한 가지 측면에서는 계층모델로 되돌아갔다. 문서 데이터베이스는 별도 테이블이 아닌 상위 레코드 내에 중첩된 레코드를 저장한다.  
하지만 다대일과 다대다 관계를 표현할 관계형 데이터베이스와 문서 데이터베이스는 근본적으로 다르지않다. 둘다 관련 항목은 고유한 식별자로 참조한다.  
관계형 모델의 외래키는 문서 모델에서는 **문서 참조(document reference)** 라 부른다.  


### 관계형 데이터베이스와 문서 데이터베이스 비교 
내결함성과 동시성 처리를 포함해서 고려해야할 점이 많이 있다. 
- 내결함성(5장), 동시성 처리(7장) 에서 설명한다.
이번 장에서는 데이터 모델의 차이점에만 집중해서 비교해본다.  
  
문서 데이터 모델을 선호하는 주요 이유는 스키마 유연성, 지역성에 기인한 더 나은 성능 때문이고 어플리케이션에서 사용하는 데이터 구조와 더 가깝기 때문이다. 
관계형 모델은 조인, 다대일/다대다 관게를 더 잘 지원한다.  

### 어떤 데이터 모델이 어플리케이션 코드를 더 간단하게 할까 ?  
