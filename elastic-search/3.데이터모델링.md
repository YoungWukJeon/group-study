## 매핑 API 이해하기

#### 매핑
    - 데이터 타입을 지정하는 과정
    - 한 번 지정된 매핑은 변경할 수 없다.
    - 타입을 변경하려면 인덱스를 삭제 후 재생성하거나 매핑을 다시 정의해야한다.
    - 실무에서는 동적 매핑을 거의 사용하지 않는다.

#### 매핑 확인
    - 형식 : GET /index명/_mapping

#### 매핑 파라미터
    - analyzer
        - 해당 필드의 데이터를 형태소 분석하겠다는 의미
        - 별도로 지정하지 않으면 Standard Analyzer로 형태소 분석 수행
    
    - normalizer
        - term query에 분석기를 사용하기 위해 사용
        - ex) cafe, Cafe, Cafe` 등을 모두 동일하게 인식할 수 있음
    
    - boost
        - 필드에 가중치(weight)를 부여
        - 검색 결과의 노출 순서에 영향을 줌
        - 색인 시점에 설정하면 변경할 때 재색인해야하므로, 검색 시점에만 사용하는 것을 권장
        - 최신 엘라스틱서치는 색인 시 boost 설정을 할 수 없도록 변경(루씬에서 제거됨)
    
    - coerce
        - 색인시 자동 형변환 가능 여부 설정
        - ex) "10"을 10으로 인식할 수 있음
    
    - copy_to
        - 매핑 파라미터를 추가한 필드의 값을 지정한 필드로 복사
        - 여러 개의 필드 데이터를 하나의 필드에 모아서 전체 검색 용도로 사용하기도 함
        - 과거의 _all 칼럼과 동일한 기능 제공
        - ex) movieNm과 movieNmEn의 결과를 결합한 "살아남은 아이 Last Child"라는 데이터를 저장하는 필드를 생성 가능

    - fielddata
        - 힙 공간에 생성하는 메모리 캐시
        - 반복적인 메모리 부족 현상과 잦은 GC로 현재는 거의 사용하지 않음
        - 최신버전에서는 doc_values를 사용(text 타입을 제외한 나머지 타입은 대부분 이걸 이용)
        - 기본적으로 비활성화
    
    - doc_values
        - 엘라스틱서치에서 사용하는 기본 캐시
        - 운영체제의 파일 시스템 캐시를 통해 디스크에 있는 데이터에 빠르게 접근할 수 있다.
        - 비활성화 시킬수 있고, 비활성화된 필드는 인덱스를 재색인하지 않는 한 변경이 불가

    - dynamic
        - 매핑에 필드를 추가할 때 동적으로 생성할지, 생성하지 않을지를 결정
        - 옵션
            - true : 새로 추가되는 필드를 매핑에 추가
            - false : 새로 추가되는 필드를 무시한다. 해당 필드는 색인되지 않아 검색할 수 없지만 _source에는 표시됨
            - strict : 새로운 필드가 감지되면 예외가 발생하고 문서 자체가 색인되지는 않음. 새로 유입되는 필드는 사용자가 매핑에 명시적으로 추가해야 함.

    - enabled
        - 검색 결과에는 포함하지만 색인은 하고 싶지 않을 경우에 사용
        - enabled를 false로 설정하면 _source에는 검색이 되지만 색인은 하지 않는다.

    - format
        - 엘라스틱서치는 날짜/시간을 문자열로 표시
        - 이를 지정하는 형식

    - ignore_above
        - 필드에 저장되는 문자열이 지정한 크기를 넘어서면 빈 값으로 색인
        - 지정한 길이를 넘어서면 완전 빈 값을 넣는다는 의미
    
    - ignore_malformed
        - 잘못된 데이터 타입을 색인하려고 하면 예외가 발생하고 해당 문서 전체가 색인되지 않는다.
        - 해당 필드만 무시하고 문서는 색인할 수 있게 해줌

    - index
        - 필드 값을 색인할지를 결정
        - 기본 값은 true

    - fields
        - 다중 필드(multi_field)를 설정할 수 있는 옵션
        - 같은 string 값을 각각 다른 분석기로 처리할 수 있도록 설정 가능

    - norms
        - 문서의 _score 값 계산에 필요한 정규화 인수를 사용할지 여부를 설정
        - 기본 값은 true
        - 검색 결과에 영향을 미칠 필요가 없는 필드를 _score에서 제거하기 위해 사용할 수 있다.(false로 설정해서)
        - _score 계산이 필요없거나 단순 필터링 용도로 사용하는 필드는 비활성화해서 디스크 공간을 절약할 수 있다.
        
    - null_value
        - null 값이 들어오면 필드를 생성하고 그에 해당하는 값으로 저장
        - ex) "null_value": "0"
    
    - position_increment_gap
        - 배열(Array) 형태의 데이터를 색인할 때 검색의 정확도를 높이기 위해 제공하는 옵션
        - 필드 데이터 중 단어와 단어 사이의 간격(slop)을 허용할지를 설정
        - ex) ["John Abraham", "Lincon Smith"]일 때, "Abraham Lincon"으로 검색 가능

    - properties
        - 오브젝트(Object) 타입이나 중첩(Nested) 타입의 스키마를 정의할 때 사용되는 옵션
        - 필드에 사용할 경우 해당 필드의 type은 없음
    
    - search_analyzer
        - 일반적으로는 색인과 검색 시 같은 분석기를 사용한다.
        - 이 옵션을 사용해 별도의 분석기를 사용할 수 있다.
    
    - similarity
        - 유사도 측정 알고리즘을 지정
        - 기본은 BM25

    - store
        - 필드의 값을 저정해 검색 결과에 값을 포함하기 위한 매핑 파라미터
        - 기본적으로 엘라스틱서치에서는 _source에 색인된 문서가 저장된다.
        - 이 옵션을 사용해 해당 필드를 자체적으로 저장할 수 있다.
        - 디스크를 더 많이 사용한다.
        - horizontal sharding 느낌(?)

    - term_vector
        - 루씬에서 분석된 용어의 정보를 포함할지 여부를 결정
        - 인자
            - no : 텀벡터를 저장하지 않음
            - yes : 필드와 용어만 저장
            - with_positions : 용어, 용어의 시작과 끝 위치를 저장
            - with_offsets : 용어, 문자 오프셋을 저장
            - with_positions_offsets : 용어, 용어의 시작과 끝 위치, 문자 오프셋을 모두 저장

## 메타 필드
- 메타데이터를 저장하는 특수 목적의 필드로 검색 시 문서를 다양한 형태로 제어하는 것이 가능
- _index 메타 필드
    - 문서가 속한 인덱스의 이름을 포함
    - 인덱스에 몇 개의 문서가 있는지 확인 가능
- _type 메타 필드
    - 문서가 속한 매핑의 타입 정보를 포함
    - 타입별로 몇 개의 문서가 있는지 확인 가능
- _id 메타 필드
    - 문서를 식별하는 유일한 키 값
- _uid 메타 필드
    - 특수한 목적의 식별키
    - '#'태그를 사용해 _type과 _id를 조합해 사용
    - 내부적으로만 사용되기 때문에 검색 시 조회되는 값은 아님
    - ex) '_doc#20173732'
- _source 메타 필드
    - 문서의 원본 데이터를 제공
    - 색인 시 전달된 원본 JSON 문서의 본문이 저장돼 있다.
- _all 메타 필드
    - 색인에 사용된 모든 필드의 정보를 가진 메타 필드
    - 모든 필드의 내용을 하나의 텍스트로 합쳐서 보관
    - 통합 검색을 구현할 때 유리할 수 있음
    - 데이터 크기를 많이 차지해서 ES 6.0이상 버전에서 deprecated됨
    - copy_to를 사용해 동일한 효과 가능
- _routing 메타 필드
    - 특정 문서를 특정 샤드에 저장하기 위해 사용자가 지정하는 메타 필드
    - 검색할 때에도 색인할 때와 마찬가지로 _routing 값을 지정해야 함

## 필드 데이터 타입
- keyword 데이터 타입
    - 키위드 형태로 사용할 데이터에 적합한 데이터 타입
    - 별도의 분석기를 거치지 않고 원문 그대로 색인
    - 특정 코드나 키워드 등 정형화된 콘텐츠에 주로 사용
    - 주된 사용처
        - 검색 시 필터링되는 항목
        - 정렬이 필요한 항목
        - 집계해야하는 항목
    - ex) "elastic search"를 검색할 때, "elastic", "search"로 검색하면 검색 안됨. "elastic search"만 검색됨
- text 데이터 타입
    - 색인 시 지정된 분석기가 컬럼의 데이터를 문자열 데이터로 인식하고 분석
    - 기본적으로 Standard_Analyzer를 사용
    - 영화 제목이나 영화의 설명글과 같이 문장 형태의 데이터에 적합
    - 전문 검색이 가능하다는 큰 장점
    - 전체 텍스트가 토큰화되어 생성되며 특정 단어를 검색하는 것이 가능
    - keyword 타입과 동시에 갖도록 멀티 필드로 설정 가능(정렬이나 집계 연산을 사용하는 등의 경우)
- Array 데이터 타입
    - 배열 형태를 저장할 때 사용
    - 모든 필드가 기본적으로 다수의 값을 가질 수 있기 때문에 매핑 시 명시적으로 Array 타입을 지정하지 않는다. 자동으로 Array 형태로 저장됨
    - 배열 내부에 객체 형태로도 저장 가능
    - 배열 내의 모든 값의 데이터 타입은 같아야 함
    - 필드가 동적으로 추가된다면 배열의 첫 번째 값이 필드의 데이터 타입을 결정
- Numeric 데이터 타입
    - 데이터의 크기에 알맞은 타입을 제공함으로써 색인과 검색을 효율적으로 처리하기 위해 다양한 종류의 숫자 타입이 제공됨
- Date 데이터 타입
    - JSON 포맷에서 문자열로 처리됨
    - 날짜는 다양하게 표현될 수 있기 때문에 날짜 문자열 형식을 명시적으로 설정해야 함
    - 기본값은 "yyyy-MM-ddTHH:mm:ssZ"
    - 내부적으로 UTC의 밀리초 단위로 변환해 저장
- Range 데이터 타입
    - 범위가 있는 데이터를 저장할 때 사용
- boolean 데이터 타입
    - 논리값을 가지는 데이터 타입. 문자열로 표현 가능(true = "true")
- Geo-Point 데이터 타입
    - 위경도 등 위치 정보를 담은 데이터를 저장할 때 사용
    - 반경 내 쿼리, 위치 기반 집계, 위치별 정렬 등을 사용할 수 있기 때문에 위치 기반 데이터를 색인하고 검색하는데 유용
- IP 데이터 타입
    - IP 주소와 같은 데이터를 저장하는데 사용
    - IPv4, IPv6를 모두 지정 가능
- Object 데이터 타입
    - JSON 포맷의 문서는 내부 객체를 계층적으로 포함할 수 있음
    - 값으로 문서를 포함할 수 있는 데이터 타입을 Object 타입이라고 함
    - Object를 정의할 때, 특정 키워드를 사용하지 않고, 단지 필드값으로 다른 문서의 구조를 입력하면 된다.
- Nested 데이터 타입
    - Object 객체 배열을 독립적으로 색인하고 질의하는 형태의 데이터 타입
    - 데이터가 배열(Array)로 저장되면 한 필드 내의 검색은 기본적으로 OR 조건으로 검색
    - 데이터의 구조가 복잡해지면 모호한 현상이 발생할 수 있음(Array를 사용할 경우)
    - 배열 내부가 객체 구조로 되어있을 때, 검색 내용 모두를 만족하는 객체들만 추출 가능
    - Nested 데이터 타입을 이용하면 검색할 때, 일치하는 문서만 정확하게 출력할 수 있음

## 분석기

- 엘라스틱서치는 루씬 기반의 텍스트 검색 엔진
- 텍스트가 분석되면 개별 텀(term)으로 나뉘어 형태소 형태로 분석됨

#### 역색인 구조
    - 색인한다는 것은 역색인 구조를 만든다는 것이다.
    - 원문 자체를 변경한다는 것은 아님
    - 색인할 때, 특정 규칙과 흐름에 의해 텍스트를 변경하는 과정을 분석(Analyze)

#### 분석기 구조
    - character filter : 문장 분석전 특정 단어를 변경하거나 HTML 태그를 제거하는데 사용
    - tokenizer filter : 텍스트를 어떻게 나눌지 정의
    - token filter : 토큰화된 단어를 사용자가 원하는 토큰으로 변환
    - 색인과 검색시 분석기를 각각 설정 가능

#### 전처리 필터
    - Html strip char 필터 : HTML 태ㅐ그를 제거
        - escaped_tags 옵션 : 특정 태그만 삭제

#### 토크나이저 필터
    - Standard 토크나이저 : 대부분의 기호를 만나면 토큰으로 나눔
        - max_token_length 옵션 : 최대 토큰 길이를 지정(default 255). 초과시 분할
    - WHITESPACE TOKENIZER : 공백을 만나면 텍스트를 토큰화
        - max_token_length 옵션 : 최대 토큰 길이를 지정(default 255). 초과시 분할
    - Ngram 토크나이저 : 기본적으로 한글자씩 토큰화. 특정문자를 지정 가능
        - min_gram 옵션 : 최소길이 지정(default 1)
        - max_gram 옵션 : 최대길이 지정(default 2)
        - token_chars 옵션 : 토큰에 포함할 문자열 타입 지정
            - letter(문자)
            - digit(숫자)
            - whitespace(공백)
            - punctuation(구두점)
            - symbol(특수기호)
    - Edge Ngram 토크나이저 : 지정문자의 목록 중 하나를 만날 때마다 시작 부분을 고정시켜 단어를 자르는 방식
        - min_gram 옵션 : 최소길이 지정(default 1)
        - max_gram 옵션 : 최대길이 지정(default 2)
        - token_chars 옵션 : 토큰에 포함할 문자열 타입 지정
            - letter(문자)
            - digit(숫자)
            - whitespace(공백)
            - punctuation(구두점)
            - symbol(특수기호)
    - Keyword 토크나이저 : 텍스트를 하나의 토큰으로 만듬
        - buffer_size 옵션 : 텀(term)을 버퍼로 읽어들일 문자 수 지정(default 256)

#### 토큰 필터
    - Ascii Folding 토큰 필터 : 아스키 범위 밖 문자를 아스키 요소로 변경
        - ex) café -> cafe
    - Lowercase 토큰 필터 : 전체 문자열을 소문자로 변환
    - Uppercase 토큰 필터 : 전체 문자열을 대문자로 변환
    - Stop 토큰 필터 : 불용어로 등록할 사전을 구축해서 사용하는 필터
        - stopwords 옵션 : 불용어 매핑을 직접 등록
        - stopwords_path 옵션 : 엘라스틱서치 서버에 config 폴더안에 생성 후 경로 지정
        - ignore_case 옵션 : true의 경우, 모든 단어를 소문자로 저장(default false)
    - Stemmer 토큰 필터 : Stemming 알고리즘을 사용해 토큰을 어간 형태로 변형하는 필터
        - name 옵션 : 변형할 언어 지정, 한글 지원x
    - Synonym 토큰 필터 : 동의어 처리를 할 수 있는 필터
        - synonyms 옵션 : 동의어로 사용할 단어 등록
        - synonyms_path 옵션 : 엘라스틱서치 서버에 config 폴더안에 생성 후 경로 지정
    - Trim 토큰 필터 : 문자열의 앞뒤 공백을 제거하는 토큰 필터

#### 동의어 사전
    - 동의어 추가 : 쉼표(,)로 분리해서 등록
        - ex) Elasticsearch, 엘라스틱서치
    - 동의어 치환 : 화살표(=>)로 분리해서 등록. 원본 토큰이 제거되고 변경된 새로운 토큰이 추가
        - ex) Harry => 해리
    - 동의어 사전은 실시간으로 적용되지 않는다.
        - 색인할 때 동의어 사전을 등록하게 되면, 동의어 사전을 변경하거나 제거한다고 할 때 재색인 작업이 필요(실시간x)
        - 검색할 때 동의어 사전을 등록하게 되면, 동의어 사전을 변경하거나 제거한다고 할 때 바로 적용됨(실시간o)

## Document API

#### 문서 파라미터
    - 문서 ID 자동 생성
        - 문서를 생성할 때 기본적으로 생성되는 ID
        - 별도로 지정하지 않으면 엘라스틱서치가 자동으로 UUID 형태의 값을 생성
    - 버전 관리
        - 색인된 모든 문서는 버전을 가지고 있다.
        - 문서에 변경이 일어날 때마다 1씩 증가한다. (삭제도 포함)
        - 데이터베이스 등 문서를 생성하는 측에서 직접 버전 값을 입력할 수도 있다. (반드시 정숫값)
    - 오퍼레이션 타입
        - Index API를 호출할 때 op_type 파라미터를 이용하면 수행되는 작업의 유형을 강제로 지정할 수 있다.
        - 색인을 할 때, 이미 존재하는 ID면 update, 존재하지 않으면 create 되는 설정 등을 변경할 수 있다.
    - 타임아웃 설정
        - 일반적으로 색인을 요청할 때 대부분은 즉시 처리된다.
        - 색인 작업 중 다른 색인 API 요청시 대기하는데 기본적으로 1분간 대기
        - ex) PUT movie_dynamic/_doc/1?timeout=5m <- 다음과 같이 타임아웃을 설정가능
    - 인덱스 매핑 정보 자동 생성
        - elasticsearch.yml에서 자동 매핑을 설정할 수 있다.
        - 옵션
            - action.auto_create_index : 인덱스 자동 생성 여부를 설정(default true)
            - index.mapper.dynamic : 동적 매핑 사용 여부를 설정(default true)

#### Index API
    - 문서를 특정 인덱스에 추가하는데 사용
    - 최소 한 개 이상의 successful 항목이 있어야 성공한 것으로 간주

#### Get API
    - 특정 문서를 인덱스에서 조회할 때 사용하는 API
    - 모든 필드가 _source 필드의 일부분으로 저장된다.
    - _source_exclude 옵션을 이용해 제외할 필드명을 지정할 수 있다.

#### Delete API
    - 문서를 삭제할 수 있다.
    - 인덱스 전체를 삭제하고 싶을 때는 인덱스명을 입력하면 된다.

#### Delete By Query
    - 특정 인덱스에서 검색을 수행한 후 그 결과에 해당하는 문서만 삭제하고 싶을 경우 사용
    - 해당 인덱스의 스냅숏을 불러와 스냅숏이 있는 문서의 버전을 기반으로 삭제를 수행

#### Update API
    - 스크립트를 바탕으로 문서를 수정할 수 있다.
    - 'ctx._source.필드명'과 같은 형태로 접근가능
    - Index에서 문서를 가져와 스크립트를 수행한 후, 이를 다시 재색인한다.
    - _source 필드가 활성화 되어있어야한다.
    - _source 뿐만 아니라 _index, _type, _id, _version, _routing, _now 등 추가적인 변수도 사용 가능

#### Bulk API
    - 한 번의 API 호출로 다수의 문서를 색인하거나 삭제할 수 있다.
    - 색인 작업의 경우 한 번에 처리함으로써 색인 속도를 크게 향상시킬 수 있다.
    - 여러 건의 데이터가 한 번에 처리되기 때문에 도중에 실패가 발생하더라도 이미 갱신되거나 수정된 결과는 롤백되지 않는다.

#### Reindex API
    - 한 인덱스에서 다른 인덱스로 문서를 복사할 때 사용
    - 기본적으로 Reindex API는 1,000건 단위로 스크롤을 수행
    - size를 지정해 스크롤 크기를 변경할 수 있다.