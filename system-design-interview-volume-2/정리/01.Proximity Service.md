### 근접성 서비스(proximity service)

문제) 주변 식당 검색 기능 구현

## 1단계: 문제 이해 및 설계 범위 확정

```
지원자 : 사용자가 검색 반경(radius)을 지정할 수 있어야 하나요? 검색 반경 내에 표시할 샇업장이 충분치 않은 경우 검색 반경을 시스템에서 알아서 넓혀도 괜찮을까요?
면접관 : 일단은 주어진 반경 내의 사업자만 검색하는 걸로 하고 시간이 남으면 주어진 범위 안에 사업장이 많지 않은 경우를 어떻게 처리할지 이야기 해보시죠

지원자 : 최대 허용 반경은 얼마입니까? 20km(12.5mile)로 가정해도 괜찮을까요?
면접관 : 네

지원자 : 사용자가 UI에서 검색 반경을 변경할 수 있어야 하나요?
면접관 : 네. 다음과 같은 선택지가 주어져야 합니다. 0.5km(0.31mile), 1km(0.62mile), 2km(1.24mile), 5km(3.1mile) 그리고 20km(12.42mile)

지원자 : 사업장 정보는 어떻게 시스템에 추가되고, 삭제되고, 갱신됩니까? 사업장 정보에 대한 작업 결과가 사용자에게 실시간으로 보여져야 할까요?
면접관 : 사업장 소유주가 시스템에 추가﹒삭제﹒갱신할 수 있어야 합니다. 새로 추가하거나 갱신한 정보는 다음날까지 반영되어야 한다고 하시죠.

지원자 : 사용자가 이동 중에 앱이나 웹사이트를 이용한다면 검색 결과를 항상 현재 위치 기준으로 유지하기 위해 화면을 자동 갱신해야 할까요?
면접관 : 사용자의 이동 속도가 그리 빠르지 않아서 그럴 필요는 없다고 칩시다.
```

### 기능 요구사항(functional requirements)
- 사용자의 위치(경위도 쌍)와 검색 반경 정보에 매치되는 사업장 목록을 반환
- 사업자 소유주가 사업장 정보를 추가﹒삭제﹒갱신할 수 있도록 하되, 그 정보가 검색 결과에 실시간으로 반영될 필요는 없음
- 고객은 사업장의 상세 정보를 살펴볼 수 있어야 함

### 비기능 요구사항(non-functional requirements)
- 낮은 응답 지연(latency): 사용자는 주변 사업장을 신속히 검색할 수 있어야 한다.
- 데이터 보호(data privacy): 사용자 위치는 민감한 정보다. 위치 기반 서비스(Location-Based Service, LBS)를 설계할 때는 언제나 사용자의 정보를 보호할 방법을 고려해야 한다. GDPR(General Data Protection Regulation)이나 CCPA(California Consumer Privacy Act) 같은 데이터 사생활 보호 법안을 준수하도록 해야 한다. (한국의 경우 ISMS?)
- 고가용성(high availability) 및 규모 확장성(scalability) 요구사항: 인구 밀집 지역에서 이용자가 집중되는 시간에 트래픽이 급증해도 감당할 수 있도록 시스템을 설계해야 한다.

### 개략적 규모 추정(back-of-the-envelope calculation)
- 일간 능동 사용자(Daily Active User, DAU)는 1억 명(100million)
- 등록된 사업장 수는 2억(200million)이라고 가정

```
QPS 계산

1d = 24h * 60m * 60s = 86,400s (계산을 쉽게 하기 위해 100,000s라 가정, 10^5)
한 사용자는 하루에 5회 검색을 시도한다고 가정
QPS = (1억 * 5) / 10^5 = 5,000
```

## 2단계: 개략적 설계안 제시 및 동의 구하기

### API 설계

#### GET /v1/search/nearby
- 특정 검색 기준에 맞는 사업장 목록을 반환
- 실제 애플리케이션의 경우 보통 페이지 단위로 나눠서 반환(이번 장에서는 제외)
- 파라미터
    - latitude: decimal 타입. 검색할 위도
    - longitude: decimal 타입. 검색할 경도
    - radius: int 타입. 선택적 인자(optional). 기본값 5,000m(대략 3마일)
- 응답
```json
{
    "total": 10,
    "businesses": [{business object}]
}
```

#### 사업장 관련 API
- GET /v1/businesses/:id => 상세 정보 반환
- POST /v1/businesses => 신규 사업장 정보 추가
- PUT /v1/businesses/:id => 사업장 정보 갱신
- DELETE /v1/businesses/:id => 사업장 정보 삭제

### 데이터 모델

#### 읽기/쓰기 비율
읽기 연산은 아래 두 기능으로 빈도 높게 발생
- 주변 사업장 검색
- 사업장 정보 확인

쓰기 연산은 비교적 빈도가 낮음
- 사업장 정보 추가, 삭제, 편집

#### 데이터 스키마 (MySQL 같은 RDB 사용)
**business 테이블**
|business||
|---|---|
|business_id|PK|
|address||
|city||
|state||
|country||
|latitude||
|longitude||

**지리적 위치 색인 테이블**
- 위치 정보 관련 연산의 효율성을 높이는 데 쓰인다.
- 지오해시(geohash)에 대한 지식이 필요하므로, 뒤에서 다시 설명

### 개략적 설계
[이미지1-2]

#### 로드밸런서
- 로드밸런서(load balancer)는 유입 트래픽을 자동으로 여러 서비스에 분산시키는 컴포넌트
- 통상적으로는 로드밸런서에 단일 DNS 진입점(entry point)을 지정하고, URL 경로를 분석하여 어느 서비스에 트래픽을 전달할지 결정한다.

#### 위치 기반 서비스(LBS)
- 시스템의 핵심 부분으로 주어진 위치와 반경 정보를 이용해서 주변 사업장을 검색한다.
- 아래와 같은 특성을 갖는다.
    - 쓰기 요청이 없는, 읽기 요청만 빈번하게 발생하는 서비스
    - QPS가 높다. 특히 특정 시간대의 인구 밀집 지역일수록 그 경향이 심하다.
    - 무상태(stateless) 서비스이므로 수평적 규모 확장이 쉽다. (지속적인 연결성(socket 등)이 불필요한 서비스)

#### 사업장 서비스
- 주로 다음 같은 두 종류의 요청을 처리
    - 사업장 소유자가 사업장 정보를 생성﹒갱신﹒삭제한다. 기본적으로 쓰기 요청이며 QPS가 낮다.
    - 고객이 사업장 정보를 조회한다. 특정 시간대에 QPS가 높아진다.

#### 데이터베이스 클러스터
- 주-부(primary-secondary) 데이터베이스 형태로 구성 가능
- 주 데이터베이스에서 쓰기 요청을 처리
- 부 데이터베이스(사본 데이터베이스)는 읽기 요청을 처리
- 데이터는 주 데이터베이스에 기록된 후 사본 데이터베이스로 복사된다.
- 복제 delay로 인해서 주-부 데이터베이스 간의 데이터 차이가 존재할 수는 있지만 사업장 정보가 실시간으로 갱신될 필요가 없기 때문에 큰 문제가 되지는 않는다.

#### 사업장 서비스와 LBS의 규모 확장성(scalability)
- 사업장 서비스와 LBS 모두 stateless 서비스이므로 점심시간 등의 특정 시간 대에 집중적으로 트래픽이 몰릴 수 있어서 자동으로 서버를 추가하여 대응하고, 야간 등 유휴 시간 대에는 서버를 삭제하도록 구성할 수 있다.
- 시스템을 클라우드에 둔다면 여러 지역, 여러 가용성 구역(availablity zone)에 서버를 두어 시스템 가용성을 높일 수 있다.

### 주변 사업장 검색 알고리즘


