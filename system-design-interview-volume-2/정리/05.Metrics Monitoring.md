# 지표 모니터링 및 경보 시스템
- 규모 확장이 용이한 지표 모니터링(metric monitoring) 및 경보 시스템(alerting system)의 설계안에 대해 다룸
- 잘 설계된 지표 모니터링 및 경보 시스템은 인프라의 상태를 선명하게 볼 수 있도록 하여 높은 가용성과 안정성을 달성하는데 중추적인 역할
- 일반적으로 사용되는 지표 모니터링 및 경보 시스템
  - ![5-1.jpg](images%2F5-1.jpg)

# 문제 이해 및 설계 범위 확정
```text
- 지원자 : 시스템의 고객은 누구인가요? 대형 IT 업체가 회사 내부에서 사용할 시스템 or 데이터독이나 스플렁크 같은 SaaS 제품 설계
- 면접관 : 회사 내부에서 사용할 시스템
- 지원자 : 어떤 지표를 수집하나요 ?
- 면접관 : 시스템 운영 지표를 수집하며, CPU 부하, 메모리 사용률, 디스크 사용량 같은 저수준의 운영체제 사용률 지표와 서버가 처리하는 초당 요청수나 웹 서버 프로세스 개수 같은 고차원적 개념에 관계된 지표일 수 있음. 사업 지표는 처리하지 않음
- 지원자 : 모니터링할 인프로 규모는 어느 정도인가요 ?
- 면접관 : 일간 능동 사용자 수 1억명, 1000개의 서버풀, 풀마다 100개의 서버 하드웨어
- 지원자 : 지표 데이터는 얼마나 오래 유지하나요 ?
- 면접관 : 1년 정도 장기 보관 필요
- 지원자 : 데이터를 장기 보관 저장소로 옮길 때, 지표의 해상도(resulution)을 낮추어도 될까요?
- 면접관 : 새로 수집한 데이터는 7일동안 보관하며, 7일 뒤에는 1분 단위 데이터로 만들어 30일 동안 보관, 그 뒤에는 1시간 단위 데이터로 변환하여 보관하는 것으로 진행
- 지원자 : 경보 채널로는 어떤 것들을 지원해야 할까요?
- 면접관 : 이메일, 전화, 페이저듀티, 웹훕(Webwook, HTTP 프로토콜을 지원하는 엔드포인트) 등을 지원
- 지원자 : 에러 로그나 액세스 로그 등에 대한 수집 기능도 제공해야 하나요 ?
- 면접관 : 아닙니다.
- 지원자 : 분산 시스템 추적 기능도 제공해야 하나요 ?
- 면접관 : 필요 없습니다.
```스

## 개략적 요구사항 및 가정
- 대규모 인프라에 대한 모니터링 진행
  - 일간 능동 사용자 수 1억 명
  - 서버 풀 1,000개, 풀당 서버 수 100개, 서버당 100개의 운영 지표를 수집한다면 모니터링 지표의 수는 천만 개 수준
  - 데이터 보관 기간은 1년
  - 데이터 원본 보관 기간은 일주일, 그 뒤에는 1분 단위로 변환하여 30일, 그 뒤에는 1시간 단위로 변환하여 1년간 보관
- 모니터링 지표
  - CPU 사용률
  - 요청 수
  - 메모리 사용량
  - 메시지 큐 내의 메시지 수

## 비기능 요구사항
1. 규모 확장성 : 시스템은 늘어나는 지표 수와 경보의 양에 맞게 확장될 수 있어야 한다.
2. 낮은 응답 지연 : 대시보드와 경보를 신속하게 처리할 수 있도록, 질의에 대한 낮은 응답 지연 보장
3. 안정성 : 높은 안정성을 제공하여 중요 경보를 놓치지 않도록 해야 한다.
4. 유연성 : 기술은 계속 변화하므로, 미래의 신기술을 쉽게 통합할 수 있도록 유연하게 변경 가능한 파이프라인을 이용해 구축한 시스템이여야 한다.

고려하지 않아도 되는 요구사항
1. 로그 모니터링 : Elasticsearch, Logstash, Kibana 등이 로그 모니터링 용도로 널리 사용되는 시스템
2. 분산 시스템 추적 : 서비스에 대한 요청이 분산 시스템 내부를 어떻게 흘러 다니는지 추적할 수 있도록 하는 시스템, 요청이 한 서비스에서 다른 서비스로 이동할 때마다 데이터 수집

# 개략적 설계안 제시 및 동의 구하기
## 기본적 사항
- 데이터 수집(data collection) : 여러 출처로부터 지표 데이터를 수집한다.
- 데이터 전송(data transmission) : 지표 데이터를 지표 모니터링 시스템으로 전송한다.
- 데이터 저장소(data storage) : 전송되어 오는 데이터를 정리하고 저장한다.
- 경보(alerting) : 밀려오는 데이터를 분석하고, 이상 징후를 감지하고, 경보를 발생시킨다. 이 시스템은 다양한 통신 채널로 경보를 발송할 수 있어야 한다.
- 시각화(visualization) : 데이터를 차트나 그래프 등으로 제공한다. 엔지니어는 데이터를 시각적으로 보여주는 패턴, 추이, 문제점을 더 쉽게 파악한다.

## 데이터 모델
- 지표 데이터는 통상 시계열(time series) 데이터 형태로 기록
- 타임스탬프가 붙은 형식으로 값을 저장하고, 고유한 이름이나 label이 붙는다.

### 사례 1
- 프로덕션에서 사용중인 인스턴스의 20:00 시점 CPU 부하
- ![5-3.jpg](images%2F5-3.jpg)

|metric_name|cpu.load|
|---|---|
|labels|host:i631,env:prod|
|timestamp|1613707265|
|value|0.29|

### 사례 2
- 지난 10분간 us-west 지역 region에 위치한 모든 웹 서버의 CPU 부하 평균값
  - 지표 이름 : CPU.load, 레이블에 포함된 지역 이름이 us-weest인 다음과 같은 데이터를 저장소에서 가져와 평균값을 구한다.
```text
CPU.load host=webserver01,region=us-west 1613707265 50
CPU.load host=webserver01,region=us-west 1613707265 62
CPU.load host=webserver02,region=us-west 1613707265 43
CPU.load host=webserver02,region=us-west 1613707265 53
...
CPU.load host=webserver01,region=us-west 1613707265 76
CPU.load host=webserver01,region=us-west 1613707265 83
```
- 각 행의 데이터 형식은 행 프로토콜(line protocol)을 따르고 있으며, 시장에 공개되는 많은 모니터링 소프트웨어가 이 형식을 준수한다. ex) prometheus, OpenTSDB

| 이름                 | 자료형                    |
|--------------------|------------------------|
| 지표 이름              | 문자열                    |
| 태그/레이블 집합          | <키:값> 쌍의 리스트(List)     |
| 지표 값 및 그 타임스탬프의 배열 | <값,타임스탬프> 쌍의 배열(Array) |

### 데이터 접근 패턴
- 그림 5.4에서 y축에 붙은 레이블은 하나의 시계열 데이터를 나타내고, x축에 붙은 레이블은 시간이다.

![5-4.jpg](images%2F5-4.jpg)

- 해당 시스템에서 쓰기 부하는 막대한대, 시점을 막론하고 많은 시계열 데이터가 기록되는데, 매일 약 천만 개의 운영 지표가 기록된다.
- 상당수의 지표는 발생 지표도 높으므로 시스템의 트래픽중 대부분은 쓰기에 해당
- 반면, 읽기 부하는 시각화와 경보 서비스가 데이터베이스에 대한 읽기 연산을 발생시키며, 그래프나 경보를 확인하는 패턴에 따라 읽기 연산은 일시적으로 증가했다가 잠잠해진다.

### 데이터 저장소 시스템
- 데이터 저장소 시스템은 해당 설계안의 핵심
- 지표 모니터링 및 경보 시스템을 위해 저장소 시스템을 직접 설계하거나, MySQL 같은 범용의 저장소 시스템을 사용하는 선택지 중 어떤 것도 추천하지 않는다.
- 어떤 DB를 선택해야하는가 ?
  - 범용 DB는 이론적으로 시계열 데이터를 처리할 수 있지만 부하 규모를 맞추려면 전문가 수준의 튜닝이 필요
  - RDB 
    - RDB의 경우 시계열 데이터를 대상으로 통상적으로 수행하는 연산에 최적화되지 않음
    - 태그/레이블에 대한 질의를 지원하려면 태그마다 인덱스를 지정해야할 필요가 있음
    - 많은 양의 쓰기 부하가 발생하는 환경에서 좋은 성능을 내기 어려움
  - NoSQL
    - 시계열 데이터를 효율적으로 처리할 수 있다고 알려진 NoSQL 중 카산드라, Bigtable
    - 하지만 이런 DB에서 시계열 데이터를 효과적으로 저장하고 질의하기 위해서는 확장이 용이한 스키마를 설계해야하고, 이를 위해서는 DB에 대한 해박한 지식 필요
  - 시계열 DB
    - 시계열 데이터에 최적화된 저장소 시스템이 많고, 잘 최적화 되어 있다.
    - 상당수가 시계열 데이터 분석에 적합하며, SQL보다 사용하기 쉬운 질의 인터페이스를 가지고 있음
    - 데이터 보관 기간이나 데이터 집계 기능을 제공하는 제품도 있어 이러한 DB를 사용하는 것이 적합
    - X는 MetricsDB, 아마존은 Timestream을 출시
    - OpenTSDB
       - Hadoop, HBase 기반으로 Hadoop/HBase 를 운영해야하기 때문에 복잡
    - 가장 인기있는 시계열 DB는 InfluxDB, Prometheus가 있다.
      - 메모리 캐시, 디스크 저장소 사용
      - 영속성 요건과 높은 성능 요구사항 만족
      - ![5-5.jpg](images%2F5-5.jpg)

### 개략적 설계안
![5-6.jpg](images%2F5-6.jpg)
- 지표 출처(metrics source) : 지표 데이터가 만들어지는 곳으로 애플리케이션 서버, SQL DB, 메시지 큐 등 어떤 것이든 가능
- 지표 수집기(metrics collector) : 지표 데이터를 수집하고 시계역 데이터에 기록하는 역할
- 시계열 데이터베이스(time-series database) : 지표 데이터를 시계열 데이터 형태로 보관하는 저장소, 다량의 시계열 데이터를 분석하고 요약하는데 적합하도록 설계된 질의 인터페이스 제공
- 질의 서비스(query service) : 질의 서비스는 시계열 DB에 보관된 데이터를 질의하고 가져오는 과정을 돕는 서비스, 좋은 시계열 DB를 골랐다면 이 서비스는 많은 일을 하지 않아도 되며, DB 질의로 대체 가능
- 경보 시스템(alerting system) : 경보를 받아야 하는 다양한 대상으로 경보 알림을 전송하는 역할을 하는 시스템
- 시각화 시스템(visualization system) : 지표를 다양한 형태의 그래프/차트로 시각화 하는 기능을 제공하는 시스템

## 상세 설계
### 지표 수집
- 카운터나 CPU 사용량 같은 지표를 수집할 때는 때로 데이터가 소실되어도 아주 심각한 문제는 아니며, 지표를 보내는 클라이언트는 성공적으로 데이터가 전송되었는지 신경 쓸 필요가 없음
- ![5-7.jpg](images%2F5-7.jpg)

여기서는 지표 데이터 수집 방법에 어떤 것이 있고 그 차이는 무엇인지를 살펴본다.

#### 풀 모델
- 실행중인 애플리케이션에서 주기적으로 지표 데이터를 가져오는 지표 수집기가 흐름의 중심
- ![5-8.jpg](images%2F5-8.jpg)
- 지표 수집기는 데이터를 가져올 서비스의 목록을 알아야 하며, 서버 안 모든 서비스 엔드포인트의 DNS/IP 정보를 담은 파일을 두면 가장 간단
- 서버가 수시로 추가/삭제되는 대규모 운영 환경에서는 적용하기 어려우며, etcd, zookeeper 같은 서비스 탐색 기술을 활용하여 해결이 가능
- 각 서비스는 가신의 가용성 관련 정보를 서비스 탐색 서비스에 기록하고 서비스 앤드포인트 목록에 변화가 생길 때마다 지표 수집기에 통보하는 형식
- 대표적으로는 prometheus가 있음

**풀 모델 기반 지표 수집 흐름**  
![5-10.jpg](images%2F5-10.jpg)
1. 지표 수집기는 SDS에서 서비스 앤드포인트 설정 메타데이터 목록을 가져온다. 메타데이터에는 지표 수집 주기, IP 주소, 타임아웃, 재시도인자 등이 기록된다.
2. 지표 수집기는 사전에 합의된 HTTP 엔드포인트에서 지표 데이터를 가져온다. 이런 엔드 포인트를 노출하기 위해 통상 서비스에 특정 클라이언트 라이브러리를 추가한다.
3. 지표 수집기는 서비스 엔드포인트 목록의 변화를 통지 받기 위한 변경 이벤트 알림 콜백을 서비스 탐색 컴포넌트에 등록하거나, 주기적으로 서비스 탐색 컴포넌트에서 엔드포인트 목록을 가져온다.

- 수천 대 서버가 만들어내는 지표 데이터를 수집하기 위해 지표 수집기 서버 한 대로는 부족하며, 지표 수집기 풀이 필요
- 여러 지표 수집기 서버가 있는 경우 데이터 중복 관련 이슈가 발생할 수 있는데, 이는 해시 링 기법을 이용하여 해결 가능
![5-11.jpg](images%2F5-11.jpg)

#### 푸시 모델
![5-12.jpg](images%2F5-12.jpg)
- 지표 출처에 해당하는 서버, 웹 서버나 DB 서버 같은 서버가 직접 지표를 수집기에 전송하는 모델
- 모니터링 대상 서버에 통상 수집 에이전트라고 부르는 소프트웨어를 설치하며, 수집 에이전트는 해당 장비에서 실행되는 서비스가 생산하는 지표 데이터를 받아 모은 다음 주기적으로 수집기에 전달
- 간단한 카운터 지표의 경우 수집기에 보내기 전에 에이전트가 직접 데이터 집계 등의 작업도 가능
- 푸시 모델에서의 전송 이슈
  - 데이터 전송 트래픽 양이 많아 수집기가 일시적으로 전송되는 데이터를 처리하지 못하는 경우, 에이전트는 내부 소규모 버퍼에 데이터를 보관했다가 재전송이 가능
  - 하지만 만약 에이전트 서버가 auto scaling이 가능하도록 설정되어 있다면, 서버가 동적으로 생성되거나 삭제되는 과정에서 데이터 손실이 발생할 가능성이 존재
  - 이런 경우 수집기 클러스터 자체도 auto scaling 기능을 이용해 자동 확장이 가능하도록 LB를 함께 사용하는 것이 바람직하다.
  - ![5-13.jpg](images%2F5-13.jpg)
- 대표적으로는 아마존 클라우드 와치, 그래파이트 등이 존재

##### 풀 모델 vs 푸시 모델
![5-3-table.jpg](images%2F5-3-table.jpg)

### 지표 전송 파이프라인의 규모 확장
![5-14.jpg](images%2F5-14.jpg)
- 지표 수집기는 서버 클러스터 형태로 엄청난 양의 데이터를 받아 처리가 필요
- 자동으로 규모 확장이 가능하도록 설정하고 언제나 데이터 처리에 충분한 수집기 서버가 존재하도록 함
- 이런 환경에서 시계열 DB에 장애가 발생하면 데이터 손실이 발생할 가능성이 있어 이를 방지하기 위한 대책 필요
- kafka와 같은 큐 시스템을 사용하면 이런 문제를 해결할 수 있으며, 아파치 스톰, 플링크, 스파크 같은 스트림 처리 서비스를 이용해 처리

![5-15.jpg](images%2F5-15.jpg)
**카프카 도입 효과**
- 고도로 안정적이고 규모 확장성이 뛰어난 분산 메시지 플랫폼
- 데이터 수집 컴포넌트와 처리 컴포넌트 사이의 결합도를 낮춤
- DB에 장애가 발생해도 데이터 손실이 없음

#### 카프카를 통한 규모 확장
- 카프카의 파티션을 사용하여 다양한 방법으로 확장이 가능
  - 대역폭 요구사항에 따라 파티션 수 설정
  - 지표 이름에 따라 어떤 지표를 어떤 파티션에 배치할지 결정하면 소비자는 지표 이름에 따라 데이터를 집계 가능
  - 태그/레이블에 따라 지표 데이터를 더욱 세분화한 파티션으로 나눔
  - 중요 지표가 먼저 처리될 수 있도록 지표를 분류하고 우선순위 지정

![5-16.jpg](images%2F5-16.jpg)

#### 카프카의 대안
- 상용 규모의 카프카 시스템 구축은 쉽지 않으며, 큐 없이도 대규모 데이터 처리가 가능한 모니터링 시스템 존재
- 페이스북의 메모리 기반 시계열 DB 시스템 고릴라
- 고릴라는 일부 네트워크 장애가 발생해도 높은 수준의 쓰기 연산 가용성 유지

### 데이터 집계 시점
- 지표 집계는 다양한 지점에서 실행 가능
  - 수집 에이전트
  - 데이터 수집 파이프라인
  - 질의 시점
- 수집 에이전트 집계 방안
  - 클라이언트에 설치된 수집 에이전트는 복잡한 집계 로직을 지원하기 어려움
  - 어떤 카운터 값을 분 단위로 집계하여 지표 수집기에 보내는 것 정도는 가능
- 데이터 수집 파이프 라인
  - 데이터를 저장소에 기록하기 전에 집계
  - 플링크 같은 스트림 프로세싱 엔진 필요
  - DB는 집계 결과만 기록하여 실제 기록되는 양은 매우 적어짐
  - 늦게 도착하는 지표 데이터의 처리가 어렵고 원본 데이터를 보관하지 않아 정밀도나 유연성 측면에서 손해 발생
- 질의 시점
  - 데이터를 날것 그대로 보관한 후 질의할 때 필요한 시간 구간에 맞게 집계
  - 데이터 손실은 없으나 질의 처리 순간 전체 데이터세트를 대상으로 집계 결과를 계산하므로 속도가 느릴 수 있음

### 질의 서비스
- 클러스터 형태로 구현
- 시각화 또는 경보 시스템에서 접수된 요청을 시계열 DB를 통해 처리하는 역할
- 질의 처리 전담 서비스를 두면 클라이언트(시각화 또는 경보 시스템)와 시계열 DB 사이의 결합도를 낮추는 것이 가능

#### 캐시 계층
![5-17.jpg](images%2F5-17.jpg)
- 질의 결과를 저장할 캐시 서버를 도입하면 시계열 DB에 대한 질의 부하를 낮추고 질의 서비스의 성능을 높일 수 있음

#### 질의 서비스를 두면 곤란한 경우
- 대부분의 상용 시각화 및 경보시스템에서 이미 지원하는 경우가 많아 별도의 캐시나 질의서비스를 두지 않아도 되는 경우가 있음

#### 시계열 DB의 질의어
- prometheus, InfluxDB 같은 널리 사용되는 지표 모니터링 시스템들은 SQL이 아닌 독자 질의어를 제공하며, 시계열 데이터에 대해 훨씬 간편하게 처리 가능

### 저장소 계층
#### 시계열 데이터베이스는 신중하게 선택할 것
- 운영 데이터 저장소에 대한 질의의 85%는 지난 26시간 내에 수집된 데이터를 대상
- 이 사실을 활용하여 시계열 DB를 고르면 성능 측면에서 큰 이득을 볼 수 있음

#### 저장 용량 최적화
##### 데이터 인코딩 및 압축
- 데이터를 인코딩하고 압축하여 크기를 상당히 줄이는 것이 가능
- ![5-18.jpg](images%2F5-18.jpg)
- timestamp 형식으로 저장하면 32비트가 필요하지만 delta를 이용해 표현한다면 4비트로 표현이 가능
- 따라서 온전한 형태가 아닌 첫 timestamp와 delta값으로 데이터를 저장 (1610087371, 10, 10, 9, 11)

##### 다운 샘플링
- 데이터의 해상도를 낮춰 저장소 요구량을 줄이는 기법
- 해당 설계안의 요구사항으로 보관 기간이 1년이였는데, 전체 데이터를 저장하기 어려우니 해상도를 낮춰 저장하는 것으로 결정했다.
  - 7일 이내 데이터 : 샘플링을 적용하지 않는다.
  - 30일 이내 데이터 : 1분 해상도로 낮춰 보관한다.
  - 1년 이내 데이터 : 1시간 해상도로 낮춰 보관한다.

10초 해상도 데이터

|지표|타임스탬프|호스트명|지표 값|  
|---|---|---|---|
|cpu|2021-10-24T19:00:00Z|host-a|10|
|cpu|2021-10-24T19:00:10Z|host-a|16|
|cpu|2021-10-24T19:00:20Z|host-a|20|
|cpu|2021-10-24T19:00:30Z|host-a|30|
|cpu|2021-10-24T19:00:40Z|host-a|20|
|cpu|2021-10-24T19:00:50Z|host-a|30|

30초 해상도로 변경된 데이터

|지표|타임스탬프|호스트명| 지표 값 |  
|---|---|---|------|
|cpu|2021-10-24T19:00:00Z|host-a| 19   |
|cpu|2021-10-24T19:00:30Z|host-a| 25   |

##### 냉동 저장소
- 잘 사용되지 않는 비활성 상태 데이터를 보관하는 곳
- 일반 저장소에 비해 훨씬 낮은 저장 비용

#### 경보 시스템
![5-19.jpg](images%2F5-19.jpg)
경보 시스템의 흐름은 아래와 같음
1. 설정 파일을 가져와 캐시 서버에 보관하고 경보 규칙은 디스크에 파일 상태로 보관 규칙에 대한 정의는 일반적으로 YAML 사용
2. 경보 관리자는 경보 설정 내역을 캐시에서 가지고 옴
3. 설정된 규칙에 근거하여 경보 관리자는 지정된 시간마다 질의하여 임계값을 위반하면 경보 이벤트를 발생하며, 아래의 작업도 같이 수행
   - 경보에 대해 필터링, 병합, 중복 제거에 대한 내용이 제공 : 짧은 시간동안 동일한 인스턴스에서 동일한 알림이 발생하면 하나의 알림으로 병합
   - 접근 제어 : 사람의 실수로 빚어지는 장애를 막고 시스템 보안 유지를 위해 경보 관리 작업은 특정한 개인만이 수행
   - 재시도 : 경보 관리자는 경보 상태를 확인하고 알림이 최소 한번은 전달됨을 보장해야함
4. 경보 저장소는 카산드라와 같은 키-값 저장소로 모든 경보의 상태가 보관
5. 경보 이벤트를 카프카에 전달
6. 경보 소비자는 카프카에서 경보 이벤트를 읽음
7. 경보 소비자는 카프카에서 읽은 경보 이벤트를 처리하여 이메일, 단문 메시지, 페이저 튜디, HTTP 엔드포인트 등 다양한 채널로 알림을 전송

##### 경보 시스템 - 만들 것인가 구매할 것인가
- 기업이 필요로 하는 규모를 지원하는 경보시스템은 시장에 많은 상황
- 시계열 데이터와 대부분 통합되는 형태로 제공
- 구현보다는 기존의 시스템과 함께 사용하는 것으로 하는 것이 효과적

#### 시각화 시스템
- 시각화 시스템은 데이터 계층 위에 생성
- 대시보드에 다양한 시간 범위에 따른 지표를 표시마여, 다양한 경보와 상태를 표시
- ![5-21.jpg](images%2F5-21.jpg)
- 품질 좋은 시각화 시스템은 구현하기 어렵기 때문에 그라파나와 같은 시스템을 이용하여 통합 구축하는 것이 좋은 선택


