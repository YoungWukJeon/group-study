# 주변 친구
- 앱 사용자 가운데 본인 위치 정보 접근 권한을 허락한 사용자에 핸해 인근의 친구 목록을 보여주는 시스템

## 문제 이해 및 설계 범위 확정
- 거리 : 5mile(8km) - 직선 거리 기준
- 이용자 수 : 10억, 기능 사용자 10%(약 1억명)
- 이동 이력 보관 여부 : O
- 비활성화 사용자 : 10분 이상 비활성화가 되는 경우 해당 사용자를 주변 친구 목록에서 제거
- 사생활 및 데이터 보호법 : 고려하지 않음

### 기능적 요구사항
- 모바일 앱을 통해 친구까지의 거리, 마지막 갱신 시간 표시
- 30초에 한번씩 갱신
- 사용자 한 명당 약 400명의 친구를 갖는다고 가정
- QPS : 10,000,000 / 30 = 334,000

### 비 기능적 요구사항
- 낮은 지연 시간 : 주변 친구의 위치 변화가 반영되는 데 걸리는 시간이 너무 오래 걸리지 않아야 한다.
- 안정성 : 몇 개의 데이터가 유실되는 것은 용인할 수 있음
- 결과적 일관성 : 위치 데이터를 저장하기 위해 강한 일관성을 지원하는 데이터 저장소를 사용할 필요는 없으며, 복제본의 데이터가 원본과 동일하게 변경되기까지 몇 초 정도 걸리는 것은 용인

## 개략적 설계안 제시 및 동의 구하기
- 근방의 활성 상태 친구의 위치 정보를 수신하고자 P2P 방식 사용 가능
- P2P를 사용하는 경우 통신 연결 상태, 전력 등의 이유로 인해 효율적이지 않으므로 공용 백엔드를 사용하는 방식으로 구성

#### 공용 백엔드의 역할
![02-03.png](images%2F02-03.png)
- 모든 활성 상태 사용자의 위치 변화 내역 수신
- 사용자 위치 변경 내역을 수신할 때마다 해당 사용자의 모든 활성 상태 친구를 찾아 친구들의 단말로 변경 내역 전송
- 두 사용자의 거리가 특정 임계치(5mile) 보다 먼 경우 내역을 전송하지 않음

##### 공용 백엔드 사용시 고려사항
- 큰 규모에 적용이 어려움
  - 주어진 문제의 가정은 활성 상태의 동시 접속 사용자가 1천만명(1억명의 10%)
  - 모두 자기 위치 정보를 30초 마다 갱신한다면 초당 334,000 번의 위치 정보 갱신을 처리해야함
  - 평균적으로 사용자 1명당 400명의 친구를 가지며 10%가 인근에 있다면 초당 334,000 * 400 * 10% = 1400만건의 정보 갱신 요청 처리 필요

### 설계안
![02-04.png](images%2F02-04.png)

#### 로드 밸런서
- RESTful API 서버 및 양방향 유상태 웹소켓 서버 앞단에 위치하며, 부하를 고르게 분산하기 위해 트래픽을 서버에 배분

#### RESTful API 서버
- 통상적인 요청/응답 트래픽 처리
- 친구 추가/삭제, 사용자 정보를 갱신하는 등의 부가적인 작업 처리

#### 웹소켓 서버
- 친구 위치 정보 변경을 거의 실시간에 가깝게 처리하는 유상태 서버 클러스터
- 클라이언트는 그 가운데 한 대와 웹소켓 연결을 지속적으로 유지
- 주변 친구 기능을 이용하는 클라이언트의 초기화도 담당
- 클라이언트가 시작되면 온라인 상태인 모든 주변 친구 위치를 해당 클라이언트로 전송하는 역할

#### 레디스 위치 정보 캐시
- 활성 상태 사용자의 가장 최근 위치 정보를 캐시
- TTL을 이용하여 기간이 지난 사용자는 비활성화 상태로 변경하고 캐시에서 삭제
- 캐시 정보가 갱신되는 경우 TTL도 갱신
- 레디스가 아닌 TTL을 지원하는 다른 키-값 저장소도 캐시로 활용 가능

#### 사용자 데이터베이스
- 사용자 데이터 및 사용자의 친구 관계 정보 저장
- RDB, NoSQL 모두 사용 가능

#### 위치 이동 이력 데이터베이스
- 사용자의 위치 변동 이력 보관

#### 레디스 pub/sub 서버
- 레디스 pub/sub은 초경량 메시지 버스
- 새로운 채널을 생성하는 것은 아주 *값싼 연산* GB급의 서버라면 수백만개의 채널 생성 가능
  -  ![02-06.png](images%2F02-06.png)
- 웹소켓 서버를 통해 수신한 특정 사용자의 위치 정보 변경 이벤트를 사용자에게 배정된 pub/sub 채널에 발행
- 사용자의 친구는 해ㅔ당 채널의 구독자
- 사용자의 위치가 변경되는 경우 모든 친구의 웹소켓 연결 핸들러가 호출되고, 수신할 친구가 활성 상태면 검색 반경 이내면 위치와 시간을 웹소켓으로 전달



